<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investments - BrickbyBrick</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* CSS VARIABLES */
        :root {
            --primary: #0F172A;
            --secondary: #1E293B;
            --accent: #3B82F6;
            --accent-hover: #2563EB;
            --text-primary: #F8FAFC;
            --text-secondary: #CBD5E1;
            --success: #10B981;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* GLOBAL STYLES */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--primary);
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.6;
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

        /* HEADER & NAV */
        header {
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        nav { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; }

        .logo { display: flex; align-items: center; gap: 12px; font-size: 24px; font-weight: 800; cursor: pointer; }
        .logo-icon { width: 40px; height: 40px; background: var(--gradient-1); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        .nav-links { display: flex; gap: 48px; list-style: none; align-items: center; }
        .nav-links a { color: var(--text-secondary); text-decoration: none; font-weight: 500; font-size: 15px; transition: color 0.3s; position: relative; }
        .nav-links a:hover { color: var(--text-primary); }
        .nav-links a::after { content: ''; position: absolute; bottom: -4px; left: 0; width: 0; height: 2px; background: var(--accent); transition: width 0.3s; }
        .nav-links a:hover::after { width: 100%; }

        /* BUTTONS */
        .btn { padding: 12px 28px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 15px; transition: all 0.3s; display: inline-block; border: none; cursor: pointer; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-hover); transform: translateY(-2px); box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3); }
        .btn-secondary { background: transparent; color: var(--text-primary); border: 2px solid var(--accent); }
        .btn-secondary:hover { background: var(--accent); }

        /* INVESTMENT CARD STYLES */
        .investment-card { background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 32px; transition: all 0.3s; }
        .investment-card:hover { transform: translateY(-4px); border-color: rgba(59, 130, 246, 0.3); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }
        .investment-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px; }
        .investment-address { font-size: 20px; font-weight: 700; }
        .investment-status { background: rgba(16, 185, 129, 0.1); color: var(--success); padding: 6px 12px; border-radius: 6px; font-size: 13px; font-weight: 600; }
        .investment-location { color: var(--text-secondary); font-size: 14px; margin-bottom: 20px; }
        .investment-details { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px; }
        .detail-item { }
        .detail-label { color: var(--text-secondary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .detail-value { font-size: 20px; font-weight: 700; }
        .investment-progress { margin-bottom: 20px; }
        .progress-label { display: flex; justify-content: space-between; font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; }
        .progress-bar { width: 100%; height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--gradient-1); transition: width 0.3s; }
        .shares-input-section { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .shares-input-group { }
        .shares-input-group label { display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600; }
        .shares-input-group input { width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: var(--text-primary); font-size: 14px; font-weight: 600; }
        .shares-input-group input:focus { outline: none; border-color: var(--accent); background: rgba(255, 255, 255, 0.08); }
        .input-validation { font-size: 11px; color: var(--text-secondary); margin-top: 4px; display: flex; justify-content: space-between; }
        .validation-error { color: #ef4444; }
        .validation-success { color: var(--success); }
        .calculation-display { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 20px; font-size: 13px; }
        .calc-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .calc-row:last-child { margin-bottom: 0; font-weight: 700; color: var(--accent); }
        .calc-label { color: var(--text-secondary); }
        .buy-btn { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .buy-btn:hover { background: var(--accent-hover); transform: translateY(-2px); }
        .buy-btn:disabled { background: rgba(59, 130, 246, 0.3); cursor: not-allowed; transform: none; }
        .error-message { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; padding: 10px; border-radius: 6px; font-size: 13px; margin-bottom: 16px; }

        /* MAIN CONTENT */
        main { padding: 140px 0 60px; min-height: 100vh; }

        .section-header { max-width: 700px; margin: 0 auto 80px; text-align: center; }
        .section-badge { display: inline-block; background: rgba(59, 130, 246, 0.1); color: var(--accent); padding: 6px 16px; border-radius: 50px; font-size: 14px; font-weight: 600; margin-bottom: 16px; }
        .section-title { font-size: 48px; font-weight: 800; margin-bottom: 16px; line-height: 1.2; }
        .section-description { font-size: 20px; color: var(--text-secondary); }

        /* TABS */
        .tabs-container { display: flex; gap: 16px; margin-bottom: 40px; border-bottom: 2px solid rgba(255, 255, 255, 0.1); }
        .tab-btn { padding: 12px 24px; background: none; border: none; color: var(--text-secondary); font-size: 16px; font-weight: 600; cursor: pointer; position: relative; transition: color 0.3s; }
        .tab-btn:hover { color: var(--text-primary); }
        .tab-btn.active { color: var(--accent); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px; background: var(--accent); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* SEARCH BAR */
        .search-container { margin-bottom: 40px; }
        .search-container input {
            width: 100%; padding: 14px 20px; background: rgba(255, 255, 255, 0.08); border: 2px solid rgba(59, 130, 246, 0.3); 
            border-radius: 12px; color: var(--text-primary); font-size: 16px; transition: all 0.3s;
        }
        .search-results { margin-top: 8px; max-width: 700px; }
        .search-item { padding: 10px 12px; background: rgba(255,255,255,0.03); border-radius: 8px; cursor: pointer; margin-bottom: 8px; transition: background 0.15s; }
        .search-item:hover { background: rgba(59,130,246,0.08); }
        .card-highlight { box-shadow: 0 0 0 4px rgba(59,130,246,0.12); border-color: rgba(59,130,246,0.3); transform: translateY(-4px); }
        .search-container input:focus { outline: none; border-color: var(--accent); background: rgba(255, 255, 255, 0.1); }

        /* GRID */
        .investments-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 24px; }

        /* Property image */
        .investment-image { width: 100%; height: 220px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(147, 51, 234, 0.3)); border-radius: 12px; overflow: hidden; margin-bottom: 16px; }
        .investment-image img { width: 100%; height: 100%; object-fit: cover; display: block; }

        footer { background: var(--primary); border-top: 1px solid rgba(255, 255, 255, 0.1); padding: 60px 0 40px; margin-top: 120px; }
        .footer-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 48px; margin-bottom: 48px; }
        .footer-section h4 { font-size: 16px; font-weight: 700; margin-bottom: 16px; }
        .footer-links { list-style: none; }
        .footer-links li { margin-bottom: 12px; }
        .footer-links a { color: var(--text-secondary); text-decoration: none; font-size: 14px; transition: color 0.3s; }
        .footer-links a:hover { color: var(--accent); }
        .footer-bottom { padding-top: 32px; border-top: 1px solid rgba(255, 255, 255, 0.1); text-align: center; color: var(--text-secondary); font-size: 14px; }

        @media (max-width: 768px) {
            nav > div:last-child { display: flex !important; gap: 8px; }
            nav .btn { padding: 8px 16px !important; font-size: 14px; }
            .nav-links { display: none; }
            .investments-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <header>
        <nav class="container">
            <div class="logo" onclick="window.location.href='index.html'">
                <div class="logo-icon">üè†</div>
                <span>BrickbyBrick</span>
            </div>
            <div id="walletDisplay" style="background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); padding: 8px 16px; border-radius: 50px; color: var(--success); font-weight: 700;">
                Wallet: Loading...
            </div>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="investments.html">Investments</a></li>
            </ul>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" onclick="window.location.href='index.html#features'">Learn More</button>
                <button class="btn btn-secondary" onclick="handleLogout()" id="logoutBtn" style="display: none;">Logout</button>
            </div>
        </nav>
    </header>

    <main>
        <div class="container">
            <div class="section-header">
                <span class="section-badge">Your Portfolio</span>
                <h2 class="section-title">Manage Your Investments</h2>
                <p class="section-description">Browse available properties or track your current holdings</p>
            </div>

            <!-- TABS -->
            <div class="tabs-container">
                <button class="tab-btn active" onclick="switchTab('available')">Available Properties</button>
                <button class="tab-btn" onclick="switchTab('myinvestments')">My Investments</button>
            </div>

            <!-- AVAILABLE PROPERTIES TAB -->
            <div id="available" class="tab-content active">
                <div class="search-container">
                    <input type="text" id="searchInvestments" placeholder="Search properties by address or city..." 
                        onkeyup="filterInvestments()">
                    <div id="searchResults" class="search-results"></div>
                </div>

                <!-- Rankings + Chat (above listings) -->
                <div id="rankingsChatContainer" style="margin-bottom:24px; display:grid; grid-template-columns: 1fr 380px; gap:20px; align-items:start;">
                    <div id="rankings">
                        <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
                            <h3 style="margin:0; font-size:18px;">Top 5 Lowest Risk</h3>
                            <small style="color:var(--text-secondary);">and Top 5 Highest Risk</small>
                        </div>
                        <div style="display:flex; gap:16px;">
                            <ul id="lowestRiskList" style="list-style:none; padding:0; margin:0; flex:1;"></ul>
                            <ul id="highestRiskList" style="list-style:none; padding:0; margin:0; flex:1;"></ul>
                        </div>
                    </div>

                    <div id="advisorChat" style="background:var(--secondary); border:1px solid rgba(255,255,255,0.06); border-radius:12px; padding:12px;">
                        <div style="font-weight:700; margin-bottom:8px;">BrickbyBrick Advisor</div>
                        <div id="chatMessages" style="height:260px; overflow:auto; padding:8px; background:rgba(255,255,255,0.02); border-radius:8px; margin-bottom:8px;"></div>
                        <div style="display:flex; gap:8px;">
                            <input id="chatInput" placeholder="Ask the advisor a question..." style="flex:1; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:var(--text-primary);" />
                            <button id="chatSend" class="btn btn-primary">Send</button>
                        </div>
                    </div>
                </div>

                <div id="investmentsGrid" class="investments-grid">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- MY INVESTMENTS TAB -->
            <div id="myinvestments" class="tab-content">
                <div id="myInvestmentsGrid" class="investments-grid">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section"><h4>Product</h4><ul class="footer-links"><li><a href="#">Features</a></li><li><a href="#">Pricing</a></li><li><a href="#">Security</a></li></ul></div>
                <div class="footer-section"><h4>Company</h4><ul class="footer-links"><li><a href="#">About Us</a></li><li><a href="#">Careers</a></li><li><a href="#">Blog</a></li></ul></div>
                <div class="footer-section"><h4>Resources</h4><ul class="footer-links"><li><a href="#">Documentation</a></li><li><a href="#">Help Center</a></li><li><a href="#">API</a></li></ul></div>
                <div class="footer-section"><h4>Legal</h4><ul class="footer-links"><li><a href="#">Privacy Policy</a></li><li><a href="#">Terms of Service</a></li></ul></div>
            </div>
            <div class="footer-bottom"><p>&copy; 2026 BrickbyBrick. All rights reserved.</p></div>
        </div>
    </footer>

    <script>
        const API_BASE = window.STOCKHOUSE_API || 'http://localhost:3001';
        const INVESTMENTS_API = `${API_BASE}/properties`;
        const CHAT_API = `${API_BASE}/api/chat`;

        let investmentProperties = [];

        const imagePaths = [
            "House Images/architecture-3414399_1280.jpg",
            "House Images/holiday-home-177401_1280.jpg",
            "House Images/house-3133771_1280.jpg",
            "House Images/house-3150500_1280.jpg",
            "House Images/house-4304096_1280.jpg",
            "House Images/house-4384774_1280.jpg",
            "House Images/house-4498947_1280.jpg",
            "House Images/large-home-389271_1280.jpg",
            "House Images/phil-hearing-IYfp2Ixe9nM-unsplash.jpg",
            "House Images/webaliser-_TPTXZd9mOo-unsplash.jpg"
        ].map(p => encodeURI(p));

        // Extract leading street number from an address (e.g., '123 Main St' -> '123')
        function extractStreetNumber(address) {
            if (!address || typeof address !== 'string') return null;
            const m = address.trim().match(/^\s*(\d+)\b/);
            return m ? m[1] : null;
        }

        // Deterministic image selection based on a property key (id or address)
        function getImageForKey(key) {
            if (!key) return imagePaths[0];
            // djb2 hash
            let hash = 5381;
            for (let i = 0; i < key.length; i++) {
                hash = ((hash << 5) + hash) + key.charCodeAt(i); /* hash * 33 + c */
                hash = hash & hash; // keep in 32-bit int
            }
            const idx = Math.abs(hash) % imagePaths.length;
            return imagePaths[idx];
        }
        let userInvestments = [];

        // Switch between tabs
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Load user investments if switching to that tab
            if (tabName === 'myinvestments') {
                loadUserInvestments();
            }
        }

        // Fetch and display properties
        async function fetchInvestmentProperties() {
            try {
                const response = await fetch(INVESTMENTS_API);
                if (!response.ok) throw new Error('Failed to fetch properties');
                const data = await response.json();
                investmentProperties = Array.isArray(data) ? data : (data.properties || []);
                // compute rankings and render
                computeAndRenderRankings();
                renderInvestmentCards();
            } catch (error) {
                console.error('Error fetching investments:', error);
                document.getElementById('investmentsGrid').innerHTML = `
                    <div style="grid-column: 1/-1; padding: 40px; text-align: center; color: var(--text-secondary);">
                        ‚ö†Ô∏è Failed to load investments. Make sure backend is running on ${INVESTMENTS_API}
                    </div>
                `;
            }
        }


        // Render investment cards with Demo-Specific Randomized Baselines
        function renderInvestmentCards() {
            const grid = document.getElementById('investmentsGrid');
            if (!grid) return;

            if (investmentProperties.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; color: var(--text-secondary);">No properties available yet</div>';
                return;
            }

            const userType = localStorage.getItem('userType');

            grid.innerHTML = investmentProperties.map((prop, idx) => {
                // 1. Data Parsing
                const availableShares = Number(prop.availableShares);
                const totalShares = Number(prop.totalShares) || 10000;
                
                // 2. Real Investor Activity Calculation
                const availablePercent = (availableShares / totalShares) * 100;
                const soldPercentActual = 100 - availablePercent;

                // 3. === DEMO FEATURE: Deterministic Randomized 51% - 89% Baseline ===
                // Using property ID as a seed ensures the baseline stays the same for each house
                const propSeed = prop._id ? prop._id.split('').reduce((a, b) => a + b.charCodeAt(0), 0) : idx;
                const demoBaseline = 51 + (propSeed % 39); // Pick a number from 51 to 89
                
                // Total Progress = Randomized Homeowner Baseline + Real Community Purchases
                const totalFundedPercent = Math.min(demoBaseline + soldPercentActual, 100);

                // 4. Buying Logic & Caps (Fixed: Defined before use)
                const maxUserCap = prop.perUserShareCap || 200;
                const canBuy = availableShares > 0;
                const investorAllowed = userType == 'investor';

                const buySection = canBuy
                    ? (investorAllowed
                        ? `
                        <div class="shares-input-section">
                            <div class="shares-input-group">
                                <label>Shares to Buy</label>
                                <input type="number" id="shares-${prop._id}" min="0" max="${Math.min(availableShares, maxUserCap)}" value="0" 
                                    oninput="updateInvestmentCalculation('${prop._id}', ${prop.sharePrice}, ${maxUserCap}, ${availableShares})">
                                <div class="input-validation">
                                    <span>Max: ${Math.min(availableShares, maxUserCap)} shares</span>
                                    <span id="shares-error-${prop._id}" style="color: var(--text-secondary);"></span>
                                </div>
                            </div>
                            <div class="shares-input-group">
                                <label>Ownership %</label>
                                <div style="padding: 10px; background: rgba(255, 255, 255, 0.05); border-radius: 8px; font-weight: 600; color: var(--accent);" id="ownership-${prop._id}">0.00%</div>
                            </div>
                        </div>

                        <div class="calculation-display">
                            <div class="calc-row"><span class="calc-label">Share Price:</span><span>$${Math.round(prop.sharePrice).toLocaleString('en-US')}</span></div>
                            <div class="calc-row"><span class="calc-label">Quantity:</span><span id="qty-${prop._id}">0 shares</span></div>
                            <div class="calc-row"><span class="calc-label">Total Cost:</span><span id="total-${prop._id}">$0</span></div>
                        </div>

                        <button class="buy-btn" id="btn-${prop._id}" onclick="buyShares('${prop._id}', '${prop.address}', ${prop.sharePrice})" disabled>
                            Buy Now
                        </button>`
                        : `<div class="error-message">üîí Investor access only.</div>`)
                    : `<div class="error-message">üîí Fully allocated.</div>`;

                // 5. Asset Visuals (Image logic)
                const streetKey = extractStreetNumber(prop.address) || String(prop._id || idx);
                let imageUrl = getImageForKey(String(streetKey));
                if (prop.images && Array.isArray(prop.images) && prop.images.length > 0) {
                    imageUrl = prop.images[0];
                }

                return `
                    <div class="investment-card" id="prop-${prop._id}">
                        <div class="investment-image" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.3), rgba(147, 51, 234, 0.3)), url('${imageUrl}') center/cover;"></div>
                        <div class="investment-header">
                            <div>
                                <div class="investment-address">${prop.address}</div>
                                <div class="investment-location">üìç ${prop.city || ''}, ${prop.state || ''}</div>
                            </div>
                            <div class="investment-status">${canBuy ? '‚úì Available' : '‚äó Sold Out'}</div>
                        </div>

                        <div class="investment-details">
                            <div class="detail-item"><div class="detail-label">Share Price</div><div class="detail-value">$${Math.round(prop.sharePrice).toLocaleString('en-US')}</div></div>
                            <div class="detail-item"><div class="detail-label">Valuation</div><div class="detail-value">$${Math.round(prop.valuation).toLocaleString('en-US')}</div></div>
                            <div class="detail-item"><div class="detail-label">Available</div><div class="detail-value">${availableShares}/${totalShares}</div></div>
                        </div>

                        <div class="investment-progress">
                            <div class="progress-label"><span>Total Equity Funded</span><span>${totalFundedPercent.toFixed(1)}%</span></div>
                            <div class="progress-bar"><div class="progress-fill" style="width: ${totalFundedPercent}%"></div></div>
                        </div>

                        ${buySection}
                        <button class="btn btn-secondary" style="width:100%; margin-top:10px; font-size:12px; padding:8px;" onclick="syncProperty('${prop._id}')">
                            üîÑ Sync Oracle Price
                        </button>
                    </div>
                `;
            }).join('');
        }
        // Calculate and display purchase details
        function updateInvestmentCalculation(propertyId, sharePrice, maxUserCap, availableShares) {
            const input = document.getElementById(`shares-${propertyId}`);
            const button = document.getElementById(`btn-${propertyId}`);
            const ownershipEl = document.getElementById(`ownership-${propertyId}`);
            const qtyEl = document.getElementById(`qty-${propertyId}`);
            const totalEl = document.getElementById(`total-${propertyId}`);
            const errorEl = document.getElementById(`shares-error-${propertyId}`);

            let shareCount = parseInt(input.value) || 0;
            let errorMsg = '';

            if (shareCount < 0) {
                shareCount = 0;
                input.value = 0;
            }

            if (shareCount > maxUserCap) {
                shareCount = maxUserCap;
                input.value = maxUserCap;
                errorMsg = `Capped at ${maxUserCap}`;
            }

            if (shareCount > availableShares) {
                shareCount = availableShares;
                input.value = availableShares;
                errorMsg = `Only ${availableShares} available`;
            }

            const totalCost = shareCount * sharePrice;
            const ownership = shareCount > 0 ? (shareCount / 10000 * 100).toFixed(2) : 0;

            ownershipEl.textContent = `${ownership}%`;
            qtyEl.textContent = `${shareCount} shares`;
            totalEl.textContent = `$${Math.round(totalCost).toLocaleString('en-US')}`;
            
            if (errorMsg) {
                errorEl.innerHTML = `<span class="validation-error">${errorMsg}</span>`;
            } else if (shareCount > 0) {
                errorEl.innerHTML = `<span class="validation-success">‚úì Ready</span>`;
            } else {
                errorEl.textContent = '';
            }

            button.disabled = shareCount === 0;
        }

        // Buy shares with confirmation
        function buyShares(propertyId, address, sharePrice) {
            const shareCount = parseInt(document.getElementById(`shares-${propertyId}`).value) || 0;
            if (shareCount === 0) return;

            const totalCost = shareCount * sharePrice;
            const confirmed = confirm(`Purchase ${shareCount} shares of ${address}?\n\nTotal Cost: $${Math.round(totalCost).toLocaleString('en-US')}`);

            if (confirmed) {
                alert(`‚úÖ Purchase confirmed! ${shareCount} shares purchased for $${Math.round(totalCost).toLocaleString('en-US')}\n\nTransaction pending...`);
                document.getElementById(`shares-${propertyId}`).value = 0;
                updateInvestmentCalculation(propertyId, sharePrice, 200, 10000);
            }
        }

        // Buy shares with confirmation
        function buyShares(propertyId, address, sharePrice) {
            const shareCount = parseInt(document.getElementById(`shares-${propertyId}`).value) || 0;
            if (shareCount === 0) return;

            const totalCost = shareCount * sharePrice;
            const confirmed = confirm(`Purchase ${shareCount} shares of ${address}?\n\nTotal Cost: $${Math.round(totalCost).toLocaleString('en-US')}`);

            if (confirmed) {
                // Save to database
                savePurchase(propertyId, address, shareCount, sharePrice, totalCost);
            }
        }

        // Save purchase to database
                async function savePurchase(propertyId, address, shareCount, sharePrice, totalCost) {
            const userId = localStorage.getItem('userId');
            const token = localStorage.getItem('authToken');
            
            try {
                const response = await fetch('http://localhost:3001/properties/purchase', { // FIX: Use /purchase
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        userId,
                        propertyId,
                        sharesToBuy: shareCount, // Key name change to match backend
                        isResident: false
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`‚úÖ Purchase successful!\nNew Balance: $${Math.round(result.newBalance).toLocaleString()}`);
                    
                    // UI REFRESH
                    updateWalletUI(); // Update the header balance
                    fetchInvestmentProperties(); // Refresh available pool
                    loadUserInvestments(); // Refresh portfolio tab
                } else {
                    throw new Error(result.error || 'Purchase failed');
                }
            } catch (error) {
                alert(`‚ùå Purchase failed: ${error.message}`);
            }
        }

        // Load user's investments
        async function loadUserInvestments() {
            const grid = document.getElementById('myInvestmentsGrid');
            const userId = localStorage.getItem('userId');
            const token = localStorage.getItem('authToken');

            if (!userId) {
                grid.innerHTML = '<div class="error-message">Please log in to see your assets.</div>';
                return;
            }

            try {
                console.log('üì° Fetching live portfolio from backend...');
                // Citing the backend portfolio route
                const response = await fetch(`http://localhost:3001/properties/portfolio/${userId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load portfolio');

                const data = await response.json(); // returns { summary, assets }
                const userAssets = data.assets;

                if (userAssets.length === 0) {
                    grid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 60px;">
                            <h3>No Investments Yet</h3>
                            <p>Go to "Available Properties" to buy your first Brick.</p>
                        </div>`;
                    return;
                }

                // Render the real assets from the database
                grid.innerHTML = userAssets.map(asset => {
                    const profitColor = asset.unrealizedProfit >= 0 ? 'var(--success)' : '#ef4444';
                    
                    return `
                        <div class="investment-card">
                            <div class="investment-header">
                                <div>
                                    <div class="investment-address">${asset.address}</div>
                                    <div class="investment-location">üìç ${asset.propertyId}</div>
                                </div>
                                <div class="investment-status" style="background: rgba(59, 130, 246, 0.1); color: var(--accent);">
                                    ${asset.equityPercentage}% Owned
                                </div>
                            </div>

                            <div class="investment-details">
                                <div class="detail-item">
                                    <div class="detail-label">Shares</div>
                                    <div class="detail-value">${asset.sharesOwned}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Current Value</div>
                                    <div class="detail-value">$${Math.round(asset.currentMarketValue).toLocaleString()}</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">Profit/Loss</div>
                                    <div class="detail-value" style="color: ${profitColor}">
                                        $${Math.round(asset.unrealizedProfit).toLocaleString()}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 10px; display: flex; justify-content: space-between;">
                                <span>Original Cost: $${Math.round(asset.totalInvestment).toLocaleString()}</span>
                                <span style="font-weight: bold; color: ${profitColor}">${asset.appreciation} ‚Üë</span>
                            </div>
                        </div>
                    `;
                }).join('');

                // Update the Global Equity Header
                if (document.getElementById('portfolioValue')) {
                    document.getElementById('portfolioValue').textContent = `$${Math.round(data.summary.totalPortfolioValue).toLocaleString()}`;
                }

            } catch (e) {
                console.error('Portfolio Error:', e);
                grid.innerHTML = '<div class="error-message">Error loading live assets.</div>';
            }
        }

        async function updateWalletUI() {
            const userId = localStorage.getItem('userId');
            if (!userId) return;

            try {
                const response = await fetch(`http://localhost:3001/wallet/balance/${userId}`);
                const data = await response.json();
                document.getElementById('walletDisplay').textContent = `Wallet: $${Math.round(data.balance).toLocaleString()}`;
            } catch (err) {
                console.error('Failed to fetch balance:', err);
            }
        }

        // Check authentication on page load
        function checkLoginStatus() {
            const logoutBtn = document.getElementById('logoutBtn');
            console.log('‚úÖ Loading investments page');
            
            // Check if user is logged in to show/hide logout button
            const token = localStorage.getItem('authToken');
            if (token && logoutBtn) {
                logoutBtn.style.display = 'block';
            }
            
            updateWalletUI(); // Fetch initial balance
            fetchInvestmentProperties();
        }

        // Compute risk scores and render top-5 lists
        function computeAndRenderRankings() {
            if (!Array.isArray(investmentProperties) || investmentProperties.length === 0) {
                document.getElementById('lowestRiskList').innerHTML = '<li style="color:var(--text-secondary)">No properties yet</li>';
                document.getElementById('highestRiskList').innerHTML = '';
                return;
            }

            const maxVal = Math.max(...investmentProperties.map(p => Number(p.valuation) || 0), 1);

            const scored = investmentProperties.map(p => {
                const availablePercent = (Number(p.availableShares) / Number(p.totalShares)) * 100;
                const soldPercentActual = 100 - (isFinite(availablePercent) ? availablePercent : 0);
                const totalFundedPercent = Math.min(51 + soldPercentActual, 100);
                const normVal = (Number(p.valuation) || 0) / maxVal;
                // risk: higher when less funded and larger valuation
                const risk = (100 - totalFundedPercent) * (0.5 + normVal);
                return { id: String(p._id || p.externalPropertyId || ''), prop: p, risk, funded: totalFundedPercent };
            });

            const byLow = scored.slice().sort((a, b) => a.risk - b.risk).slice(0, 5);
            const byHigh = scored.slice().sort((a, b) => b.risk - a.risk).slice(0, 5);

            const lowHtml = byLow.map(s => `<li style="padding:6px 8px; border-radius:8px; background: rgba(255,255,255,0.02); margin-bottom:8px; cursor:pointer;" data-id="${s.id}"><strong>${s.prop.address}</strong><div style="font-size:12px;color:var(--text-secondary)">Risk ${s.risk.toFixed(1)} ‚Äî ${s.prop.city || ''}${s.prop.city && s.prop.state ? ', ' : ''}${s.prop.state || ''}</div></li>`).join('');
            const highHtml = byHigh.map(s => `<li style="padding:6px 8px; border-radius:8px; background: rgba(255,255,255,0.02); margin-bottom:8px; cursor:pointer;" data-id="${s.id}"><strong>${s.prop.address}</strong><div style="font-size:12px;color:var(--text-secondary)">Risk ${s.risk.toFixed(1)} ‚Äî ${s.prop.city || ''}${s.prop.city && s.prop.state ? ', ' : ''}${s.prop.state || ''}</div></li>`).join('');

            document.getElementById('lowestRiskList').innerHTML = lowHtml;
            document.getElementById('highestRiskList').innerHTML = highHtml;

            // attach click handlers to scroll to property card
            document.querySelectorAll('#lowestRiskList li, #highestRiskList li').forEach(li => {
                li.addEventListener('click', () => {
                    const id = li.dataset.id;
                    const el = document.getElementById('prop-' + id);
                    if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        el.classList.add('card-highlight');
                        setTimeout(() => el.classList.remove('card-highlight'), 2000);
                    }
                });
            });

            // store small context for chat: top ids and short summaries
            window.__stockhouse_ranking_context = {
                topLow: byLow.map(s => ({ id: s.id, address: s.prop.address, city: s.prop.city, risk: Number(s.risk.toFixed(1)) })),
                topHigh: byHigh.map(s => ({ id: s.id, address: s.prop.address, city: s.prop.city, risk: Number(s.risk.toFixed(1)) }))
            };
        }


        // Chat UI helpers
        function appendChatMessage(role, text) {
            const box = document.getElementById('chatMessages');
            const el = document.createElement('div');
            el.style.marginBottom = '8px';
            el.innerHTML = `<div style="font-size:12px;color:var(--text-secondary);">${role}</div><div style="padding:8px;border-radius:8px;background:${role==='You'?'rgba(59,130,246,0.12)':'rgba(255,255,255,0.02)'}">${text}</div>`;
            box.appendChild(el);
            box.scrollTop = box.scrollHeight;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = (input.value || '').trim();
            if (!text) return;
            
            appendChatMessage('You', text);
            input.value = '';
            
            // Add a temporary "Thinking" ID
            const thinkingId = 'thinking-' + Date.now();
            appendChatMessage('Advisor', `<span id="${thinkingId}">Thinking...</span>`);
            
            const sendBtn = document.getElementById('chatSend');
            sendBtn.disabled = true;

            try {
                const res = await fetch(`${API_BASE}/api/chat`, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ 
                        message: text, 
                        // Citing the global ranking context built in your script
                        context: window.__stockhouse_ranking_context || {} 
                    })
                });
                
                const data = await res.json();
                
                // Remove the "Thinking..." block
                const thinkingEl = document.getElementById(thinkingId);
                if (thinkingEl) thinkingEl.closest('div').parentElement.remove();
                
                appendChatMessage('Advisor', data.reply);
            } catch (err) {
                console.error('Advisor Error:', err);
                const thinkingEl = document.getElementById(thinkingId);
                if (thinkingEl) thinkingEl.textContent = "Error: Could not reach the P2P network.";
            } finally {
                sendBtn.disabled = false;
            }
        }

        // wire chat send button and enter key
        document.addEventListener('click', (e) => {
            if (e.target && e.target.id === 'chatSend') sendChatMessage();
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.activeElement && document.activeElement.id === 'chatInput') {
                e.preventDefault(); sendChatMessage();
            }
        });

        // Filter investments by address/city and show clickable results that scroll to the card
        function filterInvestments() {
            const q = (document.getElementById('searchInvestments').value || '').trim().toLowerCase();
            const resultsEl = document.getElementById('searchResults');
            if (!resultsEl) return;

            if (!q) {
                // show all cards
                investmentProperties.forEach(p => {
                    const el = document.getElementById('prop-' + p._id);
                    if (el) el.style.display = '';
                });
                resultsEl.innerHTML = '';
                return;
            }

            const matches = investmentProperties.filter(p => {
                const addr = (p.address || '').toLowerCase();
                const city = (p.city || '').toLowerCase();
                return addr.includes(q) || city.includes(q);
            });

            // toggle visibility
            investmentProperties.forEach(p => {
                const el = document.getElementById('prop-' + p._id);
                if (el) el.style.display = matches.includes(p) ? '' : 'none';
            });

            if (matches.length === 0) {
                resultsEl.innerHTML = '<div class="search-item" style="opacity:0.8">No matches</div>';
                return;
            }

            resultsEl.innerHTML = matches.map(m => `<div class="search-item" data-id="${m._id}">${m.address} ‚Äî ${m.city || ''}</div>`).join('');

            // attach click handlers
            resultsEl.querySelectorAll('.search-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const propId = e.currentTarget.getAttribute('data-id');
                    // ensure Available tab active
                    try { switchTab('available'); } catch (_) {}
                    // small delay to ensure DOM rendered
                    setTimeout(() => {
                        const card = document.getElementById('prop-' + propId);
                        if (!card) return;
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        card.classList.add('card-highlight');
                        setTimeout(() => card.classList.remove('card-highlight'), 2200);
                    }, 150);
                });
            });
        }

        // Logout function
        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userId');
                alert('Logged out successfully');
                window.location.href = 'index.html';
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkLoginStatus();
        });

        // Header background on scroll
        window.addEventListener('scroll', () => {
            const header = document.querySelector('header');
            if (window.pageYOffset > 100) {
                header.style.background = 'rgba(15, 23, 42, 0.95)';
            } else {
                header.style.background = 'rgba(15, 23, 42, 0.8)';
            }
        });
    </script>
</body>
</html>
